
### 전처리기를 사용할 때 주의해야 할 수칙
---

#### Error 1
---

- 헤더 파일을 include 하기 전에 매크로를 정의하는 것을 주의하라.
	함수 f의 인자 value가 매크로 value 로 치환되었다.

```cpp
// "Myheader.h"
void f(int value)
{
	std::cout << value + 3 << "\n";
}

#include <iostream>
// #define value // f(4)가 3 출력(의도x)
#include "Myheader.h"
#define value // f(4)가 7 출력
using namespace std;

int main()
{
	f(4);
	return 0;
}
```

#### Error 2
---

- `#if defined` 를 사용할 때 매크로를 정의한 파일을 추가했는지 확인해라.
```cpp
// #include "macro_definition.hpp" // ENABLE_DEBUG 을 정의한 헤더를 까먹고 추가를 안 했네!

# if defined(ENABLE_DEBUG) 
	void f(int v) { cout << v << endl; return v * 3; } 
# else 
	void f(int v) { return v * 3; } 
# endif 

# if ENABLE_DEBUG // 0 or 1로 평가됨 
	void f(int v) { cout << v << endl; return v * 3; } 
# else 
	void f(int v) { return v * 3; } 
# endif
```


#### Error 3
---

- 매크로를 정의할 때 괄호 사용에 주의해라.
	- 정의한 매크로 텍스트 그대로 치환된다.
```cpp
#include <iostream>
#define SUB1(a,b) a - b
#define SUB2(a,b) (a-b)
#define SUB3(a,b) ((a)-(b))
using namespace std;

int main()
{
	cout << 5 * SUB1(2, 1) << "\n"; // 5*2-1 로 치환된다.
	cout << SUB2(2+2, 1+1) << "\n"; // (2+2-1+1) 로 치환된다.
	cout << SUB3(2+2, 1+1) << "\n"; // ((2+2)-(1+1)) 로 치환된다.
	return 0;
}
```


#### Error 4
---

- 긴 매크로의 사용은 컴파일을 힘들게 만든다.
```cpp
#include <iostream>

#define F(a) {   \
			...  \
			...   \
			return v;

int main() {
	F(3); // 오류가 발생할 경우, 매크로의 어느 라인에서 발생한 오류인지 찾기 어려움.
}
```


#### Error 5
---

- 매크로의 정의에 따라서 표현식의 평가가 달라져 오류를 발생시킬 수 있다.
	아래 코드의 check()와 CHECK()는 아무것도 하지 않음.
```cpp
#include <iostream>
#if defined(DEBUG)
#   define CHECK(EXPR) std::cout << "EXPR : " << EXPR << "\n";
void check(bool b) { std::cout << "do someting" << b << "\n"; }
#else
#	define CHECK(EXPR)
void check(bool b) {};
#endif
using namespace std;

bool f() { return true; }

int main()
{
	check(f());
	CHECK(f());

	return 0;
}
```


#### Error 6
---

- 다중 라인 매크로에서 중괄호를 사용해라.
```cpp
// "nuclear.h"
void nuclear_launch()
{
	std::cout << "nuclear launch detected" << std::endl;
}

#include <iostream>
#include "nuclear.h"
#define NUCLEAR { \
		std::cout << "start nuclear explosion" << std::endl; \
		nuclear_launch();}

// 위 define에 중괄호를 지우면
// "nuclear launch detected"가 출력된다.
int main()
{
	bool never_happen = false;
	if (never_happen)
		NUCLEAR
	return 0;
}
```


#### Error 7
---

- 메크로는 스코프가 없다는 것을 잊지 말자.
	함수 안에서 매크로를 선언해도 다른 곳에서 쓰일 수 있다.
```cpp
void f() {
#define value 4;
	std::cout << value;
}

int main()
{
	f(); // print 4;
	std::cout << value; // print 4;
#define value 3;
	f(); // print 4
	std::cout << value; // print 3
	return 0;
}
```


#### Error 8
---

- 매크로에 인자로 side effect를 가진 값을 넣지 않도록 주의하자.
	매크로가 표현식을 여러 번 평가해, i, j의 값이 예상하지 않은 값으로 바뀔 수 있다.
```cpp
# define MIN(a, b) ((a) < (b) ? (a) : (b))

int main() 
{
	int array1[] = { 1, 5, 2 };
	int array2[] = { 6, 3, 4 };
	int i = 0;
	int j = 0;
	int v1 = MIN(array1[i++], array2[j++]);
	std::cout << v1 << "\n"; // print 5
	int v2 = MIN(array1[i++], array2[j++]); // undefined behavior
	std::cout << v2 << "\n"; // seg fault (이상한 값 출력)
}
```


#### Error 9
---

- 매크로는 undefined behavior을 가질 수 있다.
	`defined` 매크로는 `if` 매크로와 같이 쓰자.
```cpp
# define MY_MACRO defined(EXTERNAL_MACRO)
# if MY_MACRO
# define MY_VALUE 1
# else
# define MY_VALUE 0
# endif

int f() { return MY_VALUE; }

int main()
{
	std::cout << f() << "\n"; // print 0. but 정의되지 않은 동작임.
	return 0;
}
```

